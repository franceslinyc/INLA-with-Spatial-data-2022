---
title: "00_Leukemia_in_NY"
author: "Frances Lin"
date: "3/23/2022"
output: pdf_document
---

## Load packages

```{r}
# Load packages
library(spdep)
library(DClusterm) # data
library(tidyverse)
library(pander)
library(ggplot2)
library(gridExtra)
```


```{r}
library(DClusterm)
data(NY8)
```


## The `NY8` data

The `NY8` data set contains the number of leukemia cases in an eight-country region of upstate New York from 1978-1982. 

```{r}
# Load data
data(NY8)

# View data
#head(NY8)
NY8
```

```{r}
# Check class
class(NY8)
```

```{r}
# Convert it to a df? 
# https://www.paulamoraga.com/book-geospatial/sec-spatialdataandCRS.html
NY8@data %>% head %>% pander
```

```{r}
# # Plot it 
# plot(NY8) # Just the map now.
```


## Plotting 

```{r}
# Convert to sf
library(sf)
NY8_sf <- st_as_sf(NY8)
```

```{r}
# Create the standardized mortality ratio (SMR) variable
# https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/
rate <- sum(NY8_sf$Cases) / sum(NY8_sf$POP8)

NY8_sf <- NY8_sf %>% mutate(
  Expected = POP8 * rate, 
  SMR = Cases / Expected
)
```

```{r}
# Plot SMR 
ggplot(NY8_sf) + geom_sf(aes(fill = SMR)) + # Look nice!
  scale_fill_gradient(high = "red") 
```


## Subsetting then plotting

```{r}
# Subset to include Syracuse city only 
syracuse <- which(NY8$AREANAME == "Syracuse city")

# Plot it
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = SMR)) + 
  scale_fill_gradient(high = "red") 
```


## Poisson Models

### Fitting a Poisson regression model 

```{r}
#install.packages("INLA") # run once
#not available for this R version...
#install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE) # load a while
library(INLA) # Now it works.
```

Let's work on some toy examples first before coming to fix the issue. Toy examples work fine. Issues seem to related to `Cases`. Rounding `Cases` work but results differ a bit. 

```{r}
# Fit a Poisson regression model
m1 <- inla(round(Cases) ~ 1 + AVGIDIST,
           data = NY8_sf,
           family = "poisson",
           E = NY8_sf$Expected,
           control.predictor = list(compute = TRUE),
           control.compute = list(dic = TRUE, waic = TRUE))
```

```{r}
# summary(m1) %>% pander # very bad!
```

```{r}
summary(m1)
```


### Fitting a Poisson regression model with random effects 

```{r}
# Fit a Poisson regression model with random effects 
NY8_sf <- NY8_sf %>% mutate(
  ID = 1:nrow(NY8)) # Use ID as the random effect

m2 <- inla(round(Cases) ~ 1 + AVGIDIST + f(ID, model = "iid"),
  data = NY8_sf, 
  family = "poisson",
  E = NY8_sf$Expected,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))
```

```{r}
summary(m2)
```


### Plotting

```{r}
# Add fitted values for both m1 & m2
NY8_sf <- NY8_sf %>% mutate(
  FIXED_EFF = m1$summary.fitted[, "mean"],
  IID_EFF = m2$summary.fitted[, "mean"]
  ) 
```

```{r}
# Plot them but for Syracuse city only
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = SMR)) + 
  scale_fill_gradient(high = "red", limits = c(0, 13)) -> p_m0
p_m0
```

```{r}
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = FIXED_EFF)) + #, show.legend = FALSE) +
  scale_fill_gradient(high = "red", limits = c(0, 13)) -> p_m1
p_m1 
```

```{r}
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = IID_EFF)) + # , show.legend = FALSE) +
  scale_fill_gradient(high = "red", limits = c(0, 13)) -> p_m2
p_m2
```

We might want them plotted with the same scale. 

```{r}
#grid.arrange(p_m0, p_m1, p_m2, nrow = 3, ncol = 1)
```


## Spatial Models for Lattice Data

### Plot spatial neighbors

An adjacency matrix is often used to describe spatial proximity in lattice data. 

```{r}
# Compute adjacency matrix
NY8.nb <- poly2nb(NY8) # neighbors
NY8.nb
```

```{r}
class(NY8.nb)
```

```{r}
# Plot spatial neighbors using ggplot2 
# https://mbjoseph.github.io/posts/2018-12-27-plotting-spatial-neighbors-in-ggplot2/
NY8_sp <- as(NY8_sf, 'Spatial')  # NY8_sf is a "sf" "data.frame"
class(NY8_sp) # Now is a "SpatialPolygonsDataFrame"
```

```{r}
neighbors <- poly2nb(NY8)
neighbors_sf <- as(nb2lines(neighbors, coords = coordinates(NY8_sp)), 'sf')
neighbors_sf <- st_set_crs(neighbors_sf, st_crs(NY8_sf))
```

```{r}
ggplot(NY8_sf) + 
  geom_sf() + # remove aes(fill = SMR)
  geom_sf(data = neighbors_sf)
```

```{r}
#plot(NY8) 
```

```{r}
# plot(NY8) 
# plot(NY8.nb, coordinates(NY8), add = TRUE, pch = ".", col = "gray")
```


## Generalized Linear Models With Spatial Random Effects

The GLMs have the following form: 
$$
Y = X \beta + Z u + \varepsilon,
$$
where $\beta$ is a vector of fixed effects, $u$ is a vector of random effects, 

The vector of random effects $u$ is modeled as MVN: 
$$
u \sim N(0, \sigma^2_u \Sigma), 
$$
where $\Sigma$ is defined s.t. it induces higher correlation with adjacent areas.

There are a few ways to include spatial dependence in $\Sigma$: 

1. SAR (Simultaneous autoregressive): 

2. CAR (Conditional autoregressive): 

3. ICAR (Intrinsic CAR): , etc.

### Fit 

### Fit

```{r}
# m.bym = inla(Cases ~ 1 + AVGIDIST + 
#                f(ID, model = "bym", graph = NY8.mat),
#              data = as.data.frame(NY8), E = NY8$Expected, family ="poisson",
#              control.predictor = list(compute = TRUE),
#              control.compute = list(dic = TRUE, waic = TRUE))
```


\newpage


## Reference 

GÃ³mez-Rubio, V. (2019). R-bloggers. Spatial Data Analysis with INLA. [https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/.](https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/)



