---
title: "00_Leukemia_in_NY"
author: "Frances Lin"
date: "3/23/2022"
output: pdf_document
---

## Load packages

```{r}
# Load packages
library(spdep)
library(DClusterm) # data
library(tidyverse)
library(pander)
library(ggplot2)
library(gridExtra)
```


```{r}
library(DClusterm)
data(NY8)
```


## The `NY8` data

The `NY8` data set contains the number of leukemia cases in an eight-country region of upstate New York from 1978-1982. 

```{r}
# Load data
data(NY8)

# View data
#head(NY8)
NY8
```

```{r}
# Check class
class(NY8)
```

```{r}
# Convert it to a df? 
# https://www.paulamoraga.com/book-geospatial/sec-spatialdataandCRS.html
NY8@data %>% head %>% pander
```

```{r}
# # Plot it 
# plot(NY8) # Just the map now.
```


## Plotting 

```{r}
# Convert to sf
library(sf)
NY8_sf <- st_as_sf(NY8)
```

```{r}
# Create the standardized mortality ratio (SMR) variable
# https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/
rate <- sum(NY8_sf$Cases) / sum(NY8_sf$POP8)

NY8_sf <- NY8_sf %>% mutate(
  Expected = POP8 * rate, 
  SMR = Cases / Expected
)
```

```{r}
# Plot SMR 
ggplot(NY8_sf) + geom_sf(aes(fill = SMR)) + # Look nice!
  scale_fill_gradient(high = "red") 
```


## Subsetting then plotting

```{r}
# Subset to include Syracuse city only 
syracuse <- which(NY8$AREANAME == "Syracuse city")

# Plot it
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = SMR)) + 
  scale_fill_gradient(high = "red") 
```


## Poisson Models

### Fitting a Poisson regression model 

```{r}
#install.packages("INLA") # run once
#not available for this R version...
#install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE) # load a while
library(INLA) # now it works?
```

Let's work on some toy examples first before coming to fix the issue. Toy examples work fine. Issues seem to related to `Cases`. Rounding `Cases` work but results differ a bit. 

```{r}
# Fit a Poisson regression model
m1 <- inla(round(Cases) ~ 1 + AVGIDIST,
           data = NY8_sf,
           family = "poisson",
           E = NY8_sf$Expected,
           control.predictor = list(compute = TRUE),
           control.compute = list(dic = TRUE, waic = TRUE))
```

```{r}
# summary(m1) %>% pander # very bad!
```

```{r}
summary(m1)
```


### Fitting a Poisson regression model with random effects 

```{r}
# Fit a Poisson regression model with random effects 
NY8_sf <- NY8_sf %>% mutate(
  ID = 1:nrow(NY8)) # Use ID as the random effect

m2 <- inla(round(Cases) ~ 1 + AVGIDIST + f(ID, model = "iid"),
  data = NY8_sf, 
  family = "poisson",
  E = NY8_sf$Expected,
  control.predictor = list(compute = TRUE),
  control.compute = list(dic = TRUE, waic = TRUE))
```

```{r}
summary(m2)
```


### Plotting

```{r}
# Add fitted values for both m1 & m2
NY8_sf <- NY8_sf %>% mutate(
  FIXED_EFF = m1$summary.fitted[, "mean"],
  IID_EFF = m2$summary.fitted[, "mean"]
  ) 
```

```{r}
# Plot them but for Syracuse city only
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = SMR)) + 
  scale_fill_gradient(high = "red", limits = c(0, 13)) + 
  labs(title = "SMR") -> p_m0
```

```{r}
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = FIXED_EFF), show.legend = FALSE) +
  scale_fill_gradient(high = "red", limits = c(0, 13)) + 
  labs(title = "FIXED_EFF") -> p_m1
#p_m1 
```

```{r}
ggplot(NY8_sf[syracuse, ]) + geom_sf(aes(fill = IID_EFF), show.legend = FALSE) +
  scale_fill_gradient(high = "red", limits = c(0, 13)) + 
  labs(title = "IID_EFF") -> p_m2
```

We want them plotted by the same scale. 

```{r}
grid.arrange(p_m0, p_m1, p_m2, nrow =2, ncol = 2)
```


## Spatial Models 



```{r}
# m.bym = inla(Cases ~ 1 + AVGIDIST + 
#                f(ID, model = "bym", graph = NY8.mat),
#              data = as.data.frame(NY8), E = NY8$Expected, family ="poisson",
#              control.predictor = list(compute = TRUE),
#              control.compute = list(dic = TRUE, waic = TRUE))
```


\newpage


## Reference 

GÃ³mez-Rubio, V. (2019). R-bloggers. Spatial Data Analysis with INLA. [https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/.](https://www.r-bloggers.com/2019/11/spatial-data-analysis-with-inla/)



